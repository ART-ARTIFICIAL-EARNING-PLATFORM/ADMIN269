<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Task Requests</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* আপনার আগের সব CSS হুবহু সেম আছে, কোনো চেঞ্জ করা হয়নি */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { 
            background: #000; 
            color: white; 
            padding: 25px 20px;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(239, 68, 68, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            animation: bgMove 15s ease-in-out infinite;
            z-index: -2;
        }

        @keyframes bgMove {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(3deg); }
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 60px 60px;
            z-index: -1;
        }

        h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #fff;
        }

        h2 i { color: #60a5fa; }

        #audioStatus {
            font-size: 13px;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(239, 68, 68, 0.2);
            margin-left: auto;
            font-weight: 500;
            cursor: pointer;
        }

        .card { 
            background: rgba(255,255,255,0.03); 
            padding: 30px 25px; 
            border-radius: 24px; 
            margin-bottom: 25px; 
            border: 1px solid rgba(255,255,255,0.08);
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 100%);
            pointer-events: none;
        }

        .req-box { border-left: 4px solid #3b82f6; padding-left: 20px; margin-top: 0;}
        .req-box.review { border-left-color: #10b981; }

        .time-badge { 
            float: right; 
            font-size: 12px; 
            background: rgba(255,255,255,0.1); 
            padding: 6px 12px; 
            border-radius: 20px;
            font-weight: 500;
            color: rgba(255,255,255,0.8);
        }

        h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info { 
            font-size: 14px; 
            color: rgba(255,255,255,0.5); 
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .user-info span { display: flex; align-items: center; gap: 5px; }
        .user-info i { font-size: 14px; }

        textarea, input { 
            width: 100%; 
            padding: 16px 20px; 
            margin-top: 0;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.3); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: white; 
            border-radius: 14px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s;
        }

        textarea:focus, input:focus {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        textarea { resize: vertical; min-height: 80px; }
        textarea::placeholder, input::placeholder { color: rgba(255,255,255,0.3); }

        button { 
            padding: 14px 24px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            color: white;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn-blue:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4); }

        .btn-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .btn-green:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); }

        .btn-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); }
        .btn-red:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4); }

        .btn-yellow { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); color: #000; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3); }
        .btn-yellow:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(251, 191, 36, 0.4); }

        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .input-grid input { margin-bottom: 0; }

        .btn-group { display: flex; gap: 15px; margin-top: 15px; margin-bottom: 20px; }
        .btn-group button { flex: 1; }

        .send-btn { width: 100%; margin-top: 20px; padding: 18px; font-size: 16px; }

        .review-section p { margin-bottom: 15px; }
        .review-section p b { display: block; margin-bottom: 8px; color: rgba(255,255,255,0.7); font-weight: 500; }
        .review-section input[readonly] { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2); color: #34d399; }

        .empty-state { text-align: center; color: rgba(255,255,255,0.4); padding: 60px 20px; font-size: 16px; }
        .empty-state i { font-size: 48px; margin-bottom: 20px; color: rgba(255,255,255,0.2); }

        .particle {
            position: fixed;
            width: 3px;
            height: 3px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
        }
        .particle:nth-child(1) { top: 10%; left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { top: 70%; left: 90%; animation-delay: 2s; }
        .particle:nth-child(3) { top: 30%; left: 80%; animation-delay: 4s; }

        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.2; }
            50% { transform: translateY(-30px) scale(1.2); opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="grid-overlay"></div>
    
    <div class="particle"></div>
    <div class="particle"></div>
    <div class="particle"></div>

    <h2><i class="fas fa-tasks"></i> Task Requests <span id="audioStatus">(Click here to enable voice alert)</span></h2>

    <div id="requestsList"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        const app = initializeApp({ databaseURL: "https://tk65-58e25-default-rtdb.firebaseio.com", projectId: "tk65-58e25" });
        const db = getDatabase(app);
        
        // Voice & Notification Request setup
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        const audio = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3'); 
        let audioEnabled = false;
        
        let prevReqCount = -1;
        let prevSubCount = -1;

        // ব্রাউজারের অডিও ইঞ্জিন আনলক করা (ভয়েস ফিক্স)
        document.body.addEventListener('click', () => {
            if(!audioEnabled) {
                audioEnabled = true;
                
                // Silent speech to unlock SpeechSynthesis in Chrome/Safari
                if ('speechSynthesis' in window) {
                    let unlockSpeech = new SpeechSynthesisUtterance('');
                    window.speechSynthesis.speak(unlockSpeech);
                }
                
                // Silent audio play to unlock AudioContext
                audio.play().then(() => {
                    audio.pause();
                    audio.currentTime = 0;
                }).catch(err => console.log(err));

                document.getElementById('audioStatus').innerText = "(Voice Alert Active ✓)";
                document.getElementById('audioStatus').style.color = "#10b981";
                document.getElementById('audioStatus').style.background = "rgba(16, 185, 129, 0.1)";
                document.getElementById('audioStatus').style.borderColor = "rgba(16, 185, 129, 0.2)";
            }
        });

        // Voice Notification Function
        function notifyAndSpeak(title, message, voiceText) {
            // Browser Notification
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(title, { body: message });
            }

            if(audioEnabled) {
                // Play notification sound
                audio.play().catch(e => console.log(e));

                // Speak voice (অল্প Delay দেওয়া হয়েছে যাতে সাউন্ডের সাথে ক্ল্যাশ না করে)
                if ('speechSynthesis' in window) {
                    setTimeout(() => {
                        window.speechSynthesis.cancel(); 
                        let speech = new SpeechSynthesisUtterance(voiceText);
                        speech.lang = 'en-US';
                        speech.rate = 0.95; // ক্লিয়ার শোনার জন্য স্পিড সামান্য কমানো হয়েছে
                        window.speechSynthesis.speak(speech);
                    }, 300);
                }
            }
        }

        // Time formatter
        function timeAgo(timestamp) {
            if(!timestamp) return "Just now";
            let diff = Math.floor((Date.now() - timestamp) / 60000);
            return diff <= 0 ? "Just now" : `${diff} min ago`;
        }

        onValue(ref(db, 'tasks'), async (snapshot) => {
            let html = "";
            let tasksArray = [];
            
            let currReqCount = 0;
            let currSubCount = 0;

            snapshot.forEach((child) => {
                let data = child.val();
                tasksArray.push({ uid: child.key, ...data });
                
                if(data.status === "requested") currReqCount++;
                if(data.status === "submitted") currSubCount++;
            });

            // Smart Voice and Browser Notification Trigger
            if (prevReqCount !== -1 && prevSubCount !== -1 && audioEnabled) {
                if (currReqCount > prevReqCount) {
                    notifyAndSpeak("New Task Request", "You have a new task request from a user.", "Notification! New task applied.");
                }
                if (currSubCount > prevSubCount) {
                    notifyAndSpeak("Task Submitted", "A user has submitted a task for review.", "Notification! Task submitted.");
                }
            }
            
            prevReqCount = currReqCount;
            prevSubCount = currSubCount;

            for (let data of tasksArray) {
                const uid = data.uid;
                
                // Fetch user data from Users Table
                let userSnap = await get(ref(db, 'users/' + uid));
                let user = userSnap.val() || {};
                let phone = user.phone || "N/A";
                let success = user.successCount || 0;
                let fail = user.failCount || 0;
                
                // নাম ফিক্স: Users ডাটাবেস থেকে আসল নাম নিবে, না পেলে tasks থেকে, না পেলে Unknown
                let actualName = user.name || user.fullName || data.userName || "Unknown User";

                if(data.status === "requested") {
                    html += `
                    <div class="card req-box">
                        <span class="time-badge"><i class="fas fa-clock"></i> ${timeAgo(data.requestTime)}</span>
                        <h3><i class="fas fa-user"></i> Request: ${actualName}</h3>
                        <div class="user-info">
                            <span><i class="fas fa-phone"></i> ${phone}</span>
                            <span style="color: #34d399;"><i class="fas fa-check-circle"></i> Success: ${success}</span>
                            <span style="color: #ef4444;"><i class="fas fa-times-circle"></i> Failed: ${fail}</span>
                        </div>

                        <p style="font-size:14px; color: rgba(255,255,255,0.6); margin-bottom: 10px;">Paste raw text below to Autofill:</p>
                        <textarea id="raw_${uid}" rows="2" placeholder="Paste data here..."></textarea>
                        
                        <div class="btn-group">
                            <button class="btn-blue" onclick="autoFill('${uid}')"><i class="fas fa-magic"></i> Smart Autofill</button>
                            <button class="btn-yellow" onclick="banUser('${uid}')"><i class="fas fa-ban"></i> Ban 2 Hours</button>
                        </div>
                        
                        <div class="input-grid">
                            <input type="text" id="fName_${uid}" placeholder="First Name">
                            <input type="text" id="lName_${uid}" placeholder="Last Name">
                            <input type="text" id="pass_${uid}" placeholder="Password">
                            <input type="text" id="email_${uid}" placeholder="Email">
                            <input type="text" id="rec_${uid}" placeholder="Recovery Email">
                            <input type="text" id="birth_${uid}" placeholder="Birthdate">
                        </div>
                        <button class="btn-green send-btn" onclick="sendTask('${uid}')"><i class="fas fa-paper-plane"></i> Send Task to User</button>
                    </div>`;
                } else if (data.status === "submitted") {
                    html += `
                    <div class="card req-box review">
                        <span class="time-badge" style="background: rgba(16, 185, 129, 0.2); color: #34d399;"><i class="fas fa-check"></i> Submitted</span>
                        <h3><i class="fas fa-clipboard-check"></i> Review Task: ${actualName}</h3>
                        <div class="user-info">
                            <span><i class="fas fa-phone"></i> ${phone}</span>
                            <span style="color: #34d399;"><i class="fas fa-check-circle"></i> Success: ${success}</span>
                            <span style="color: #ef4444;"><i class="fas fa-times-circle"></i> Failed: ${fail}</span>
                        </div>
                        
                        <div class="review-section">
                            <p><b><i class="fas fa-envelope"></i> Created Email:</b> <input type="text" value="${data.userData.email}" readonly></p>
                            <p><b><i class="fas fa-lock"></i> Password:</b> <input type="text" value="${data.userData.password}" readonly></p>
                        </div>
                        
                        <input type="number" id="coinAmount_${uid}" placeholder="Enter Reward Coins (e.g. 500)" value="500">
                        <div class="btn-group">
                            <button class="btn-green" onclick="acceptTask('${uid}', ${success})"><i class="fas fa-check"></i> Accept & Pay</button>
                            <button class="btn-red" onclick="rejectTask('${uid}', ${fail})"><i class="fas fa-times"></i> Reject</button>
                        </div>
                    </div>`;
                }
            }

            document.getElementById('requestsList').innerHTML = html || `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>No active requests.</p>
                </div>`;
        });

        // Smart Autofill Logic
        window.autoFill = function(uid) {
            let text = document.getElementById(`raw_${uid}`).value;
            let elements = text.split(/[\n,]/); 
            
            elements.forEach(line => {
                let lower = line.toLowerCase();
                let val = line.includes(':') ? line.split(':')[1].trim() : line.trim();
                
                if(!val) return;

                if (lower.includes("first") || lower.includes("নাম")) {
                    document.getElementById(`fName_${uid}`).value = val;
                } else if (lower.includes("last") || lower.includes("পদবি")) {
                    document.getElementById(`lName_${uid}`).value = val;
                } else if (lower.includes("pass") || lower.includes("পাসওয়ার্ড")) {
                    document.getElementById(`pass_${uid}`).value = val;
                } else if (lower.includes("rec") || lower.includes("রিকভারি")) {
                    document.getElementById(`rec_${uid}`).value = val;
                } else if (lower.includes("birth") || lower.includes("dob")) {
                    document.getElementById(`birth_${uid}`).value = val;
                } else if (val.includes("@") && !lower.includes("rec")) {
                    document.getElementById(`email_${uid}`).value = val;
                } else if (document.getElementById(`pass_${uid}`).value === "") {
                     if(val.length > 5 && val.length < 15 && !val.includes(" ")) {
                         document.getElementById(`pass_${uid}`).value = val;
                     }
                }
            });
        }

        window.sendTask = function(uid) {
            let adminData = {
                "First Name": document.getElementById(`fName_${uid}`).value,
                "Last Name": document.getElementById(`lName_${uid}`).value,
                "Password": document.getElementById(`pass_${uid}`).value,
                "Email": document.getElementById(`email_${uid}`).value,
                "Recovery Email": document.getElementById(`rec_${uid}`).value,
                "Birthdate": document.getElementById(`birth_${uid}`).value,
            };
            update(ref(db, 'tasks/' + uid), { 
                status: "assigned", 
                adminData: adminData,
                assignTime: Date.now() 
            });
        }

        window.acceptTask = async function(uid, currentSuccess) {
            let coins = parseInt(document.getElementById(`coinAmount_${uid}`).value) || 0;
            let userRef = ref(db, 'users/' + uid);
            let snapshot = await get(userRef);
            if(snapshot.exists()) {
                let user = snapshot.val();
                let newBal = (user.balance || 0) + coins;
                let newSuccess = (currentSuccess || 0) + 1;
                
                await update(userRef, { balance: newBal, successCount: newSuccess });
                await remove(ref(db, 'tasks/' + uid));
            }
        }

        window.rejectTask = async function(uid, currentFail) {
            let newFail = (currentFail || 0) + 1;
            await update(ref(db, 'users/' + uid), { failCount: newFail });
            await remove(ref(db, 'tasks/' + uid));
        }

        window.banUser = async function(uid) {
            let banTime = Date.now() + (2 * 60 * 60 * 1000); 
            await update(ref(db, 'users/' + uid), { banUntil: banTime });
            await remove(ref(db, 'tasks/' + uid)); 
            alert("User banned for 2 hours.");
        }
    </script>
</body>
</html>
