<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Task Requests</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: #1e1e2f; color: white; padding: 20px; }
        .card { background: #2a2a40; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #444; }
        textarea, input { width: 100%; padding: 10px; margin-top: 5px; background: #1e1e2f; border: 1px solid #555; color: white; border-radius: 5px; }
        button { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px; color: white;}
        .btn-blue { background: #3b82f6; } .btn-green { background: #10b981; } .btn-red { background: #ef4444; } .btn-yellow { background: #f59e0b; color:black; }
        .req-box { border-left: 4px solid #3b82f6; padding-left: 10px; margin-top: 15px; }
        .user-info { font-size: 13px; color: #aaa; margin-bottom: 10px; }
        .time-badge { float: right; font-size: 12px; background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 10px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;}
        .input-grid input { margin-top:0; }
        .btn-group { display: flex; gap:10px; margin-top: 10px;}
        .btn-group button { flex: 1; margin-top:0;}
    </style>
</head>
<body>
    <h2>Task Requests <span id="audioStatus" style="font-size: 12px; color: #ef4444;">(Click anywhere to enable voice alert)</span></h2><br>

    <div id="requestsList"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        const app = initializeApp({ databaseURL: "https://tk65-58e25-default-rtdb.firebaseio.com", projectId: "tk65-58e25" });
        const db = getDatabase(app);
        
        // Voice Notification setup
        const audio = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3'); 
        let audioEnabled = false;
        let previousCount = 0;

        // Enable audio on first click anywhere
        document.body.addEventListener('click', () => {
            if(!audioEnabled) {
                audioEnabled = true;
                document.getElementById('audioStatus').innerText = "(Voice Alert Active ‚úì)";
                document.getElementById('audioStatus').style.color = "#10b981";
            }
        }, {once:true});

        // Time formatter
        function timeAgo(timestamp) {
            if(!timestamp) return "Just now";
            let diff = Math.floor((Date.now() - timestamp) / 60000);
            return diff <= 0 ? "Just now" : `${diff} min ago`;
        }

        onValue(ref(db, 'tasks'), async (snapshot) => {
            let html = "";
            let currentCount = 0;
            let tasksArray = [];

            snapshot.forEach((child) => {
                tasksArray.push({ uid: child.key, ...child.val() });
            });

            // Play sound if NEW request is added
            if(tasksArray.length > previousCount && audioEnabled) { 
                audio.play().catch(e => console.log("Audio blocked")); 
            }
            previousCount = tasksArray.length;

            for (let data of tasksArray) {
                const uid = data.uid;
                
                // Fetch user data for stats
                let userSnap = await get(ref(db, 'users/' + uid));
                let user = userSnap.val() || {};
                let phone = user.phone || "N/A";
                let success = user.successCount || 0;
                let fail = user.failCount || 0;

                if(data.status === "requested") {
                    html += `
                    <div class="card req-box">
                        <span class="time-badge">${timeAgo(data.requestTime)}</span>
                        <h3>Request: ${data.userName}</h3>
                        <div class="user-info">
                            üìû ${phone} | ‚úÖ Success: ${success} | ‚ùå Failed: ${fail}
                        </div>

                        <p style="font-size:13px; margin-top:10px;">Paste raw text below to Autofill:</p>
                        <!-- Textarea size reduced to 2 rows -->
                        <textarea id="raw_${uid}" rows="2" placeholder="Paste data here..."></textarea>
                        
                        <div class="btn-group">
                            <button class="btn-blue" onclick="autoFill('${uid}')">‚ú® Smart Autofill</button>
                            <button class="btn-yellow" onclick="banUser('${uid}')">üö´ Ban 2 Hours</button>
                        </div>
                        
                        <div class="input-grid">
                            <input type="text" id="fName_${uid}" placeholder="First Name">
                            <input type="text" id="lName_${uid}" placeholder="Last Name">
                            <input type="text" id="pass_${uid}" placeholder="Password">
                            <input type="text" id="email_${uid}" placeholder="Email">
                            <input type="text" id="rec_${uid}" placeholder="Recovery Email">
                            <input type="text" id="birth_${uid}" placeholder="Birthdate">
                        </div>
                        <button class="btn-green" style="width:100%;" onclick="sendTask('${uid}')">Send Task to User</button>
                    </div>`;
                } else if (data.status === "submitted") {
                    html += `
                    <div class="card req-box" style="border-left-color: #10b981;">
                        <h3>Review Task: ${data.userName}</h3>
                        <div class="user-info">üìû ${phone} | ‚úÖ Success: ${success} | ‚ùå Failed: ${fail}</div>
                        <br>
                        <p><b>Created Email:</b> <input type="text" value="${data.userData.email}" readonly></p>
                        <p><b>Password:</b> <input type="text" value="${data.userData.password}" readonly></p>
                        
                        <input type="number" id="coinAmount_${uid}" placeholder="Enter Reward Coins (e.g. 500)" value="500">
                        <div class="btn-group">
                            <button class="btn-green" onclick="acceptTask('${uid}', ${success})">‚úîÔ∏è Accept & Pay</button>
                            <button class="btn-red" onclick="rejectTask('${uid}', ${fail})">‚ùå Reject</button>
                        </div>
                    </div>`;
                }
            }

            document.getElementById('requestsList').innerHTML = html || "<p style='text-align:center; color:#aaa;'>No active requests.</p>";
        });

        // Smart Autofill Logic
        window.autoFill = function(uid) {
            let text = document.getElementById(`raw_${uid}`).value;
            // Split by lines or commas
            let elements = text.split(/[\n,]/); 
            
            elements.forEach(line => {
                let lower = line.toLowerCase();
                // Extract value if it has a colon ':', else take the whole line
                let val = line.includes(':') ? line.split(':')[1].trim() : line.trim();
                
                if(!val) return;

                // Smart Matching
                if (lower.includes("first") || lower.includes("‡¶®‡¶æ‡¶Æ")) {
                    document.getElementById(`fName_${uid}`).value = val;
                } else if (lower.includes("last") || lower.includes("‡¶™‡¶¶‡¶¨‡¶ø")) {
                    document.getElementById(`lName_${uid}`).value = val;
                } else if (lower.includes("pass") || lower.includes("‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°")) {
                    document.getElementById(`pass_${uid}`).value = val;
                } else if (lower.includes("rec") || lower.includes("‡¶∞‡¶ø‡¶ï‡¶≠‡¶æ‡¶∞‡¶ø")) {
                    document.getElementById(`rec_${uid}`).value = val;
                } else if (lower.includes("birth") || lower.includes("dob")) {
                    document.getElementById(`birth_${uid}`).value = val;
                } else if (val.includes("@") && !lower.includes("rec")) {
                    // Any unassigned string with '@' is probably the target email
                    document.getElementById(`email_${uid}`).value = val;
                } else if (document.getElementById(`pass_${uid}`).value === "") {
                     // Fallback: If it's a short random string, it might be password
                     if(val.length > 5 && val.length < 15 && !val.includes(" ")) {
                         document.getElementById(`pass_${uid}`).value = val;
                     }
                }
            });
        }

        window.sendTask = function(uid) {
            let adminData = {
                "First Name": document.getElementById(`fName_${uid}`).value,
                "Last Name": document.getElementById(`lName_${uid}`).value,
                "Password": document.getElementById(`pass_${uid}`).value,
                "Email": document.getElementById(`email_${uid}`).value,
                "Recovery Email": document.getElementById(`rec_${uid}`).value,
                "Birthdate": document.getElementById(`birth_${uid}`).value,
            };
            // Send task and start the 13 minute timer trigger
            update(ref(db, 'tasks/' + uid), { 
                status: "assigned", 
                adminData: adminData,
                assignTime: Date.now() // Track when it was assigned
            });
        }

        window.acceptTask = async function(uid, currentSuccess) {
            let coins = parseInt(document.getElementById(`coinAmount_${uid}`).value) || 0;
            let userRef = ref(db, 'users/' + uid);
            let snapshot = await get(userRef);
            if(snapshot.exists()) {
                let user = snapshot.val();
                let newBal = (user.balance || 0) + coins;
                let newSuccess = (currentSuccess || 0) + 1;
                
                await update(userRef, { balance: newBal, successCount: newSuccess });
                await remove(ref(db, 'tasks/' + uid));
            }
        }

        window.rejectTask = async function(uid, currentFail) {
            let newFail = (currentFail || 0) + 1;
            await update(ref(db, 'users/' + uid), { failCount: newFail });
            await remove(ref(db, 'tasks/' + uid));
        }

        // Ban User Logic
        window.banUser = async function(uid) {
            let banTime = Date.now() + (2 * 60 * 60 * 1000); // Current time + 2 hours
            await update(ref(db, 'users/' + uid), { banUntil: banTime });
            await remove(ref(db, 'tasks/' + uid)); // Remove their current pending request
            alert("User banned for 2 hours.");
        }
    </script>
</body>
</html>
